<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Star-Duel: Arcade Shooter</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body {
            margin: 0; overflow: hidden;
            background: #020205;
            font-family: 'Courier New', Courier, monospace;
            user-select: none;
        }

        /* HUD */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
        }
        
        .health-bar-container {
            position: absolute; width: 300px; height: 12px;
            background: rgba(50,50,50,0.5); border: 1px solid #666;
            transform: skewX(-20deg);
        }
        .health-fill { height: 100%; transition: width 0.2s; }

        #p1-hud { bottom: 30px; left: 50%; transform: translateX(-50%) skewX(-20deg); }
        #p1-fill { background: #00ffcc; width: 100%; box-shadow: 0 0 10px #00ffcc; }
        
        #p2-hud { top: 30px; left: 50%; transform: translateX(-50%) skewX(-20deg); }
        #p2-fill { background: #ff3333; width: 100%; box-shadow: 0 0 10px #ff3333; }

        .label {
            position: absolute; width: 100%; text-align: center;
            color: white; font-size: 10px; top: -15px; letter-spacing: 2px;
        }

        /* MENUS */
        .menu {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #00ffcc;
            padding: 40px; text-align: center;
            color: #00ffcc; width: 300px;
            box-shadow: 0 0 20px rgba(0, 255, 204, 0.2);
            z-index: 10;
        }
        
        button {
            background: transparent; border: 1px solid #00ffcc;
            color: #00ffcc; padding: 10px 20px; margin: 10px 0;
            width: 100%; cursor: pointer; font-family: inherit;
            font-weight: bold; transition: 0.2s;
        }
        button:hover { background: #00ffcc; color: black; }
        
        input {
            background: transparent; border: 1px solid #666;
            color: white; padding: 8px; width: 90%; text-align: center;
            font-family: inherit; margin-bottom: 10px;
        }

        .hidden { display: none !important; }
        
        /* Hit Flash */
        #flash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; opacity: 0; transition: opacity 0.1s; pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="flash"></div>

    <div id="ui-layer" class="hidden">
        <div id="p2-hud" class="health-bar-container">
            <div class="label">TARGET INTEGRITY</div>
            <div id="p2-fill" class="health-fill"></div>
        </div>
        <div id="p1-hud" class="health-bar-container">
            <div class="label">SHIELD STATUS</div>
            <div id="p1-fill" class="health-fill"></div>
        </div>
    </div>

    <div id="main-menu" class="menu">
        <h1>STAR DUEL</h1>
        <button onclick="startSolo()">SOLO MISSION</button>
        <button onclick="setupHost()">HOST SERVER</button>
        <button onclick="setupJoin()">JOIN SERVER</button>
        <p style="font-size:10px; margin-top:20px; color:#aaa;">
            WASD: Move Ship<br>SPACE: Fire Cannons
        </p>
    </div>

    <div id="host-menu" class="menu hidden">
        <h3>TRANSMISSION ID</h3>
        <input type="text" id="host-id" readonly onclick="this.select(); document.execCommand('copy')">
        <p style="font-size:10px;">Share with Player 2</p>
        <button onclick="location.reload()">ABORT</button>
    </div>

    <div id="join-menu" class="menu hidden">
        <h3>INPUT ID</h3>
        <input type="text" id="join-id">
        <button onclick="connectToHost()">CONNECT</button>
        <button onclick="location.reload()">BACK</button>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
    // --- AUDIO ENGINE ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const ac = new AudioContext();

    function playSound(type) {
        if(ac.state === 'suspended') ac.resume();
        const t = ac.currentTime;
        const g = ac.createGain();
        g.connect(ac.destination);

        if(type === 'laser') {
            const osc = ac.createOscillator();
            osc.frequency.setValueAtTime(800, t);
            osc.frequency.exponentialRampToValueAtTime(100, t + 0.1);
            osc.connect(g);
            g.gain.setValueAtTime(0.05, t);
            g.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
            osc.start(); osc.stop(t + 0.1);
        } else if (type === 'hit') {
            const osc = ac.createOscillator();
            osc.type = 'square';
            osc.frequency.setValueAtTime(150, t);
            osc.frequency.exponentialRampToValueAtTime(10, t + 0.2);
            osc.connect(g);
            g.gain.setValueAtTime(0.1, t);
            g.gain.exponentialRampToValueAtTime(0.01, t + 0.2);
            osc.start(); osc.stop(t + 0.2);
        }
    }

    // --- GAME ENGINE ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    let W, H;
    const resize = () => { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; };
    window.addEventListener('resize', resize);
    resize();

    // GAME STATE
    let mode = 'menu';
    let peer = null, conn = null;
    let keys = { w:false, a:false, s:false, d:false, space:false, up:false, down:false, left:false, right:false, enter:false };

    // WORLD OBJECTS
    // Coordinate System:
    // X: -100 (Left) to 100 (Right)
    // Y: -100 (Up) to 100 (Down)
    // Z: 0 (Player) to 1000 (Boss)
    
    const player = { x: 0, y: 0, hp: 100, color: '#00ffcc', tilt: 0 };
    const boss = { x: 0, y: 0, hp: 100, color: '#ff3333', flash: 0 };
    
    let bullets = []; // { x, y, z, vx, vy, vz, owner } owner 1=player, 2=boss
    let stars = []; // For background speed effect

    // Init Stars
    for(let i=0; i<100; i++) stars.push({x:Math.random()*W, y:Math.random()*H, z:Math.random()*2});

    // --- INPUT ---
    window.addEventListener('keydown', e => {
        let k = e.key.toLowerCase();
        if(keys.hasOwnProperty(k)) keys[k] = true;
        if(e.code === 'Space') keys.space = true;
        
        // P2 controls
        if(e.key === 'ArrowUp') keys.up = true;
        if(e.key === 'ArrowDown') keys.down = true;
        if(e.key === 'ArrowLeft') keys.left = true;
        if(e.key === 'ArrowRight') keys.right = true;
        if(e.key === 'Enter') keys.enter = true;
    });
    
    window.addEventListener('keyup', e => {
        let k = e.key.toLowerCase();
        if(keys.hasOwnProperty(k)) keys[k] = false;
        if(e.code === 'Space') keys.space = false;
        
        if(e.key === 'ArrowUp') keys.up = false;
        if(e.key === 'ArrowDown') keys.down = false;
        if(e.key === 'ArrowLeft') keys.left = false;
        if(e.key === 'ArrowRight') keys.right = false;
        if(e.key === 'Enter') keys.enter = false;
    });

    // --- LOGIC LOOP ---
    function update() {
        if(player.hp <= 0 || boss.hp <= 0) return;

        // 1. Player Movement (Ship)
        const speed = 2.5;
        if(keys.w) player.y = Math.max(-80, player.y - speed);
        if(keys.s) player.y = Math.min(80, player.y + speed);
        if(keys.a) { player.x = Math.max(-120, player.x - speed); player.tilt = -15; }
        else if(keys.d) { player.x = Math.min(120, player.x + speed); player.tilt = 15; }
        else player.tilt *= 0.8; // Level out

        // 2. Boss Movement
        if(mode === 'solo') {
            // AI
            boss.x += (Math.sin(Date.now()/500) * 2); 
            boss.y += (Math.cos(Date.now()/700) * 1.5);
            
            // AI Shoot
            if(Math.random() < 0.05) fireBoss();
        } else if (mode === 'client') {
            // P2 controls Boss
            const bSpeed = 2;
            if(keys.up) boss.y -= bSpeed;
            if(keys.down) boss.y += bSpeed;
            if(keys.left) boss.x -= bSpeed;
            if(keys.right) boss.x += bSpeed;
            
            // Constrain
            boss.x = Math.max(-120, Math.min(120, boss.x));
            boss.y = Math.max(-80, Math.min(80, boss.y));

            if(keys.enter && Math.random() < 0.2) { // Rate limit P2
                fireBoss();
                if(conn) conn.send({type:'bossShoot'});
            }
            // Send Pos
            if(conn) conn.send({type:'bossMove', x:boss.x, y:boss.y});
        }

        // 3. Player Shooting
        if(keys.space && mode !== 'client') {
            // Rate limit auto-fire
            if(Math.random() > 0.8) {
                firePlayer();
            }
        }

        // 4. Update Bullets
        for(let i=bullets.length-1; i>=0; i--) {
            let b = bullets[i];
            b.z += b.vz; // Move forward/back in Z-space
            b.x += b.vx;
            b.y += b.vy;

            // Collision: Player Bullet hitting Boss
            if(b.owner === 1) {
                if(b.z >= 1000) { // Reached Boss Depth
                    if(Math.abs(b.x - boss.x) < 30 && Math.abs(b.y - boss.y) < 30) {
                        boss.hp -= 2;
                        boss.flash = 3;
                        playSound('hit');
                    }
                    bullets.splice(i, 1);
                    continue;
                }
            } 
            // Collision: Boss Bullet hitting Player
            else {
                if(b.z <= 0) { // Reached Player Depth
                    // Visual Hitbox is at the Ship's location
                    if(Math.abs(b.x - player.x) < 15 && Math.abs(b.y - player.y) < 15) {
                        player.hp -= 10;
                        document.getElementById('flash').style.opacity = 0.5;
                        setTimeout(() => document.getElementById('flash').style.opacity = 0, 50);
                        playSound('hit');
                    }
                    bullets.splice(i, 1);
                    continue;
                }
            }
        }

        // Sync Health Bars
        document.getElementById('p1-fill').style.width = player.hp + '%';
        document.getElementById('p2-fill').style.width = boss.hp + '%';
        
        if(boss.hp <= 0) endGame("PLAYER 1 WINS");
        if(player.hp <= 0) endGame("PLAYER 2 (BOSS) WINS");

        // Sync Host Data
        if(mode === 'host' && conn) {
            conn.send({
                type: 'state',
                px: player.x, py: player.y, pt: player.tilt,
                bx: boss.x, by: boss.y,
                bhp: boss.hp, php: player.hp,
                bullets: bullets
            });
        }
    }

    function firePlayer() {
        bullets.push({
            x: player.x, y: player.y, z: 0,
            vx: 0, vy: 0, vz: 40, // Fast Z speed
            owner: 1
        });
        playSound('laser');
        if(mode === 'host' && conn) conn.send({type:'sound', id:'laser'});
    }

    function fireBoss() {
        // Boss shoots AT player position
        // Calculate vector
        const dx = (player.x - boss.x) / 50;
        const dy = (player.y - boss.y) / 50;

        bullets.push({
            x: boss.x, y: boss.y, z: 1000,
            vx: dx, vy: dy, vz: -20, // Negative Z to come at screen
            owner: 2
        });
        if(mode === 'host') playSound('laser');
    }

    // --- RENDERER ---
    function draw() {
        // Clear
        ctx.fillStyle = '#050510';
        ctx.fillRect(0, 0, W, H);

        const cx = W/2;
        const cy = H/2;

        // 1. Starfield (Sense of speed)
        ctx.fillStyle = '#fff';
        stars.forEach(s => {
            s.y += (s.z * 2);
            if(s.y > H) s.y = 0;
            ctx.globalAlpha = s.z/2;
            ctx.fillRect(s.x, s.y, 2, 2);
        });
        ctx.globalAlpha = 1;

        // 2. Perspective Grid (Floor)
        ctx.strokeStyle = '#224466';
        ctx.lineWidth = 1;
        ctx.beginPath();
        for(let i=-200; i<=200; i+=50) {
            // Project X, Y, Z to Screen X, Y
            // Floor is Y = 100 world units down
            let x1 = cx + (i - player.x)*1.5; 
            let y1 = H;
            let x2 = cx + (i - player.x)*0.1; // Vanishing point
            let y2 = cy;
            ctx.moveTo(x1, y1); ctx.lineTo(x2, y2);
        }
        ctx.stroke();

        // 3. Draw Boss (Back)
        // Project Boss World Coords to Screen
        // Boss is at Z=1000. Perspective Scale = ~0.2
        const bScale = 0.3;
        const bx = cx + (boss.x - player.x) * bScale; // Parallax
        const by = cy + (boss.y - player.y) * bScale;

        // Laser Sight (Shows alignment)
        // Draw line from player to boss depth
        // If player.x is close to boss.x, aim is true
        const aimAligned = Math.abs(player.x - boss.x) < 30 && Math.abs(player.y - boss.y) < 30;
        
        ctx.strokeStyle = aimAligned ? '#ff0000' : 'rgba(0, 255, 204, 0.3)';
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 5]);
        ctx.beginPath();
        // Ship Screen Pos
        ctx.moveTo(cx, cy + 150); 
        // Projected Target Depth Pos
        let tx = cx + (0) * bScale; 
        let ty = cy + (0) * bScale;
        // Actually, we want a line straight into Z.
        // Screen X of player is CX. Screen X of same world pos at Z=1000:
        ctx.lineTo(bx, by);
        ctx.stroke();
        ctx.setLineDash([]);

        // Boss Body
        ctx.save();
        ctx.translate(bx, by);
        ctx.fillStyle = boss.flash > 0 ? '#fff' : boss.color;
        if(boss.flash > 0) boss.flash--;
        
        // Rotating Square
        ctx.rotate(Date.now()/500);
        ctx.fillRect(-30, -30, 60, 60);
        ctx.strokeStyle = 'white';
        ctx.strokeRect(-30, -30, 60, 60);
        ctx.restore();


        // 4. Draw Bullets
        bullets.forEach(b => {
            // Z=0 -> Scale 1. Z=1000 -> Scale 0.3
            const p = (b.z) / 1000; // 0 to 1 progress
            const scale = 1.2 - (p * 0.9); 
            
            // X Parallax calculation
            // If z is 0, x is relative to screen center simply.
            // If z is 1000, x is squeezed towards center.
            const screenX = cx + (b.x - player.x) * scale;
            const screenY = cy + (b.y - player.y) * scale + (150 * (1-p)); // +150 to align with player ship at bottom
            
            const size = (b.owner === 1 ? 5 : 15) * scale;
            
            ctx.fillStyle = b.owner === 1 ? '#00ffcc' : '#ffaa00';
            ctx.beginPath();
            ctx.arc(screenX, screenY, size, 0, Math.PI*2);
            ctx.fill();
        });


        // 5. Draw Player Ship (Front/Center)
        // Fixed Screen Position (bottom center), World moves around it
        const shipX = cx;
        const shipY = cy + 150;

        ctx.save();
        ctx.translate(shipX, shipY);
        ctx.rotate(player.tilt * Math.PI / 180);

        // Shield/Hitbox
        ctx.strokeStyle = 'rgba(0, 255, 204, 0.5)';
        ctx.lineWidth = 1;
        ctx.beginPath(); ctx.arc(0, 0, 20, 0, Math.PI*2); ctx.stroke();

        // Ship Body
        ctx.fillStyle = '#000';
        ctx.strokeStyle = player.color;
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(0, -20); // Nose
        ctx.lineTo(15, 15); // Wing R
        ctx.lineTo(0, 5);   // Tail
        ctx.lineTo(-15, 15);// Wing L
        ctx.closePath();
        ctx.fill(); ctx.stroke();
        
        // Engine Flame
        ctx.fillStyle = '#00ffff';
        ctx.beginPath();
        ctx.moveTo(-5, 10); ctx.lineTo(5, 10); ctx.lineTo(0, 25 + Math.random()*10);
        ctx.fill();

        ctx.restore();
    }

    function loop() {
        update();
        draw();
        requestAnimationFrame(loop);
    }

    function endGame(msg) {
        alert(msg);
        location.reload();
    }

    // --- NETWORKING ---
    function startSolo() {
        mode = 'solo';
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('ui-layer').classList.remove('hidden');
        loop();
    }

    function setupHost() {
        mode = 'host';
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('host-menu').classList.remove('hidden');
        peer = new Peer();
        peer.on('open', id => document.getElementById('host-id').value = id);
        peer.on('connection', c => {
            conn = c;
            conn.on('open', () => {
                document.getElementById('host-menu').classList.add('hidden');
                document.getElementById('ui-layer').classList.remove('hidden');
                loop();
            });
            conn.on('data', d => {
                if(d.type === 'bossMove') { boss.x = d.x; boss.y = d.y; }
                if(d.type === 'bossShoot') fireBoss();
            });
        });
    }

    function setupJoin() {
        mode = 'client';
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('join-menu').classList.remove('hidden');
    }

    function connectToHost() {
        let id = document.getElementById('join-id').value;
        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect(id);
            conn.on('open', () => {
                document.getElementById('join-menu').classList.add('hidden');
                document.getElementById('ui-layer').classList.remove('hidden');
                loop();
            });
            conn.on('data', d => {
                if(d.type === 'state') {
                    player.x = d.px; player.y = d.py; player.tilt = d.pt;
                    boss.x = d.bx; boss.y = d.by;
                    boss.hp = d.bhp; player.hp = d.php;
                    bullets = d.bullets;
                }
                if(d.type === 'sound') playSound(d.id);
            });
        });
    }

</script>
</body>
</html>